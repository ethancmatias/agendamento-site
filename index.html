/**
 * Apps Script para gerenciar agendamentos na planilha "Tabela_1".
 * Lembre-se de substituir 'SEU_SHEET_ID_AQUI' pelo ID real da sua planilha.
 */

function doPost(e) {
  try {
    const SHEET_ID = 'SEU_SHEET_ID_AQUI';
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName('Tabela_1');
    const p = e.parameter;

    // Extrai parâmetros
    const nome     = p.nome;
    const cpf      = p.cpf;
    const telefone = p.telefone;
    const local    = p.local;
    const data     = p.data;
    const horario  = p.horario;
    const acao     = p.acao;

    if (acao === 'agendar') {
      // Adiciona uma nova linha:
      // Colunas: Nome | CPF | Telefone | Local | Data | Horário | Ação
      sheet.appendRow([nome, cpf, telefone, local, data, horario, 'agendar']);
    } else if (acao === 'cancelar') {
      // Procura pelo agendamento existente e altera somente a coluna Ação
      const rows = sheet.getDataRange().getValues();
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        // row[0]=Nome, [1]=CPF, [2]=Telefone, [3]=Local, [4]=Data, [5]=Horário, [6]=Ação
        if (
          row[1] === cpf &&
          row[2] === telefone &&
          row[3] === local &&
          row[4] === data &&
          row[5] === horario &&
          row[6] === 'agendar'
        ) {
          // Atualiza a coluna Ação para 'cancelar'
          sheet.getRange(i + 1, 7).setValue('cancelar');
          break;
        }
      }
    }

    // Retorna resposta de sucesso
    return ContentService
      .createTextOutput(JSON.stringify({status: 'ok'}))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    // Retorna resposta de erro com a mensagem
    return ContentService
      .createTextOutput(JSON.stringify({status: 'error', message: err.message}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
