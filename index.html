/**
 * Back-end do Sistema de Agendamento (Google Apps Script)
 * Siga estes passos:
 * 1) Na sua planilha, veja o ID puro na URL (entre '/d/' e '/edit').
 * 2) Substitua o valor de SHEET_ID abaixo pelo ID puro.
 * 3) Salve e em Deploy → Nova implantação → Web app:
 *    • Executar como: Você
 *    • Quem tem acesso: Qualquer pessoa, mesmo anônima
 * 4) Copie a URL '/exec' resultante e cole em ENDPOINT no front-end.
 *
 * A aba da planilha deve se chamar exatamente 'Tabela_1' com cabeçalhos:
 * Nome | CPF | Telefone | Local | Data | Horário | Ação
 */

const SHEET_ID = '1pZHnjlyRvogLUc-JuL_gcZ9K8n142LUBZy2WwiK-Ock'; // <- Cole aqui o ID puro da planilha

function doPost(e) {
  const p = e.parameter;
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName('Tabela_1');

  if (p.acao === 'agendar') {
    sheet.appendRow([
      p.nome || '',
      p.cpf || '',
      p.telefone || '',
      p.local || '',
      p.data || '',
      p.horario || '',
      'agendar'
    ]);
  } else if (p.acao === 'cancelar') {
    const rows = sheet.getDataRange().getValues();
    for (let i = 1; i < rows.length; i++) {
      const r = rows[i];
      if (
        r[1] === p.cpf &&
        r[2] === p.telefone &&
        r[3] === p.local &&
        r[4] === p.data &&
        r[5] === p.horario &&
        r[6] === 'agendar'
      ) {
        sheet.getRange(i + 1, 7).setValue('cancelar');
        break;
      }
    }
  }

  return ContentService
    .createTextOutput(JSON.stringify({ status: 'ok' }))
    .setMimeType(ContentService.MimeType.JSON);
}
