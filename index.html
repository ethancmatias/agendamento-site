<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamento Piscicultores - Açude Castanhão</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
      padding: 2rem;
    }
    .container {
      background: white;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input, select, button {
      width: 100%;
      padding: 0.8rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      margin-top: 1rem;
    }
    .error {
      color: red;
      margin-top: 1rem;
    }
    .success {
      color: green;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div style="text-align:center; margin-bottom: 1rem;">
    <img src="MAPAAssinatura.png" alt="Ministério da Pesca e Aquicultura - Governo Federal" style="max-width: 400px; height: auto;">
  </div>
  <div class="container">
    <h2>Agendamento Piscicultores - Açude Castanhão</h2>
    <form id="agendamentoForm">
      <label for="local">Local:</label>
      <select id="local" required>
        <option value="">Selecione...</option>
        <option value="Jaguaribara-CE">Jaguaribara-CE</option>
        <option value="Curupati Peixe-CE">Curupati Peixe-CE</option>
      </select>

      <label for="data">Data:</label>
      <select id="data" required></select>

      <label for="horario">Horário:</label>
      <select id="horario" required></select>

      <label for="nome">Nome:</label>
      <input type="text" id="nome" required />

      <label for="cpf">CPF:</label>
      <input type="text" id="cpf" required maxlength="14" placeholder="000.000.000-00" />

      <button type="submit">Agendar</button>
      <button type="button" id="cancelarBtn">Cancelar Agendamento</button>
      <div id="mensagem" class="success"></div>
    </form>
  </div>

  <script>
    const form = document.getElementById('agendamentoForm');
    const localSelect = document.getElementById('local');
    const dataSelect = document.getElementById('data');
    const horarioSelect = document.getElementById('horario');
    const mensagemDiv = document.getElementById('mensagem');
    const cancelarBtn = document.getElementById('cancelarBtn');

    const datas = {
      "Jaguaribara-CE": ["12/05", "13/05", "15/05", "16/05"],
      "Curupati Peixe-CE": ["14/05"]
    };

    const horarios = {
      "Jaguaribara-CE": ["17:00", "17:15", "17:30", "17:45", "18:00", "18:15", "18:30", "18:45", "19:00", "19:15", "19:30", "19:45", "20:00", "20:15", "20:30", "20:45"],
      "Curupati Peixe-CE": ["13:00", "13:15", "13:30", "13:45", "14:00", "14:15", "14:30", "14:45", "15:00", "15:15", "15:30", "15:45", "16:00", "16:15", "16:30", "16:45"]
    };

    const agendamentos = {};

    localSelect.addEventListener('change', e => {
      const local = e.target.value;
      dataSelect.innerHTML = '<option value="">Selecione...</option>';
      horarioSelect.innerHTML = '<option value="">Selecione...</option>';
      if (datas[local]) {
        datas[local].forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          dataSelect.appendChild(opt);
        });
      }
    });

    dataSelect.addEventListener('change', () => {
      const local = localSelect.value;
      const data = dataSelect.value;
      horarioSelect.innerHTML = '<option value="">Selecione...</option>';

      if (horarios[local]) {
        horarios[local].forEach(h => {
          const key = `${local}|${data}|${h}`;
          const quantidade = agendamentos[key]?.length || 0;
          const opt = document.createElement('option');
          opt.value = h;
          opt.textContent = `${h} (${quantidade}/5 vagas)`;
          if (quantidade >= 5) {
            opt.disabled = true;
          }
          horarioSelect.appendChild(opt);
        });
      }
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      mensagemDiv.textContent = '';
      const nome = document.getElementById('nome').value;
      const cpf = document.getElementById('cpf').value;
      const local = localSelect.value;
      const data = dataSelect.value;
      const horario = horarioSelect.value;
      const key = `${local}|${data}|${horario}`;

      fetch('https://script.google.com/macros/s/AKfycbz8mxO5Qf8fpPm_N3BzVWKn9NkM_0V8IhT5nsYAbWGwv2Iv9I9kup4EE1GswyrLrseWFQ/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `nome=${encodeURIComponent(nome)}&cpf=${encodeURIComponent(cpf)}&local=${encodeURIComponent(local)}&data=${encodeURIComponent(data)}&horario=${encodeURIComponent(horario)}&acao=agendar`
      });

      if (!agendamentos[key]) agendamentos[key] = [];

      if (agendamentos[key].length >= 5) {
        mensagemDiv.textContent = 'Esse horário já está cheio. Escolha outro.';
        mensagemDiv.className = 'error';
        return;
      }

      agendamentos[key].push({ nome, cpf });
      mensagemDiv.textContent = `Agendamento realizado com sucesso para ${nome} em ${data} às ${horario}`;
      mensagemDiv.className = 'success';
      form.reset();
      horarioSelect.innerHTML = '<option value="">Selecione...</option>';
    });

    cancelarBtn.addEventListener('click', () => {
      const nome = document.getElementById('nome').value;
      const cpf = document.getElementById('cpf').value;
      const local = localSelect.value;
      const data = dataSelect.value;
      const horario = horarioSelect.value;
      const key = `${local}|${data}|${horario}`;

      fetch('https://script.google.com/macros/s/AKfycbz8mxO5Qf8fpPm_N3BzVWKn9NkM_0V8IhT5nsYAbWGwv2Iv9I9kup4EE1GswyrLrseWFQ/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `nome=${encodeURIComponent(nome)}&cpf=${encodeURIComponent(cpf)}&local=${encodeURIComponent(local)}&data=${encodeURIComponent(data)}&horario=${encodeURIComponent(horario)}&acao=cancelar`
      });

      if (!agendamentos[key]) {
        mensagemDiv.textContent = 'Nenhum agendamento encontrado para esse horário.';
        mensagemDiv.className = 'error';
        return;
      }

      const index = agendamentos[key].findIndex(entry => entry.cpf === cpf);
      if (index !== -1) {
        agendamentos[key].splice(index, 1);
        mensagemDiv.textContent = `Agendamento cancelado com sucesso para ${nome} em ${data} às ${horario}`;
        mensagemDiv.className = 'success';
        form.reset();
        horarioSelect.innerHTML = '<option value="">Selecione...</option>';
      } else {
        mensagemDiv.textContent = 'Agendamento não encontrado ou CPF incorreto.';
        mensagemDiv.className = 'error';
      }
    });
  </script>
</body>
</html>
