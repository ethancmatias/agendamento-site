<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamento Piscicultores - Açude Castanhão</title>
  <style>
    body { font-family: sans-serif; background-color: #f5f5f5; padding: 2rem; }
    .container {
      background: white;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input, select, button {
      width: 100%;
      padding: 0.8rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      margin-top: 1rem;
    }
    .mensagem {
      margin-top: 1rem;
      font-weight: bold;
    }
    .erro { color: red; }
    .sucesso { color: green; }
    .logo {
      text-align: center;
      margin-bottom: 1rem;
    }
    .logo img {
      max-width: 400px;
      height: auto;
    }
  </style>
</head>
<body>
  <div class="logo">
    <img src="MAPAAssinatura.png" alt="Ministério da Pesca e Aquicultura - Governo Federal">
  </div>
  <div class="container">
    <h2>Agendamento Piscicultores - Açude Castanhão</h2>
    <form id="form">
      <label for="local">Local:</label>
      <select id="local" required>
        <option value="">Selecione o Local</option>
        <option value="Jaguaribara-CE">Jaguaribara-CE</option>
        <option value="Curupati Peixe-CE">Curupati Peixe-CE</option>
      </select>

      <label for="data">Data:</label>
      <select id="data" required></select>

      <label for="horario">Horário:</label>
      <select id="horario" required></select>

      <label for="nome">Nome:</label>
      <input type="text" id="nome" required />

      <label for="cpf">CPF:</label>
      <input type="text" id="cpf" required maxlength="14" placeholder="000.000.000-00" />

      <button type="submit">Agendar</button>
      <button type="button" id="cancelarBtn">Cancelar Agendamento</button>
      <div class="mensagem" id="mensagem"></div>
    </form>
  </div>
  <script>
    const datas = {
      "Jaguaribara-CE": ["12/05", "13/05", "14/05", "15/05", "16/05"],
      "Curupati Peixe-CE": ["12/05", "13/05", "14/05", "15/05", "16/05"]
    };
    const horarios = {
      "Jaguaribara-CE": ["17:00", "17:15", "17:30", "17:45", "18:00", "18:15", "18:30", "18:45", "19:00", "19:15", "19:30", "19:45", "20:00", "20:15", "20:30", "20:45"],
      "Curupati Peixe-CE": ["13:00", "13:15", "13:30", "13:45", "14:00", "14:15", "14:30", "14:45", "15:00", "15:15", "15:30", "15:45", "16:00", "16:15", "16:30", "16:45"]
    };
    const URL_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSxlA-2uJraWzvgM8156v8SFZHXK6n5rc0JkB-8WA-H3z3Y9ft9H5Yp03GRZwaW0SEcdC9s9iD6qz8e/pub?output=csv';

    const localSel = document.getElementById('local');
    const dataSel = document.getElementById('data');
    const horarioSel = document.getElementById('horario');
    const form = document.getElementById('form');
    const mensagem = document.getElementById('mensagem');
    const cancelarBtn = document.getElementById('cancelarBtn');

    localSel.addEventListener('change', () => {
      const local = localSel.value;
      dataSel.innerHTML = '<option value="">Selecione a Data</option>';
      if (datas[local]) {
        datas[local].forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          dataSel.appendChild(opt);
        });
      }
    });

    dataSel.addEventListener('change', () => {
      const local = localSel.value;
      horarioSel.innerHTML = '<option value="">Selecione o Horário</option>';
      if (horarios[local]) {
        horarios[local].forEach(h => {
          const opt = document.createElement('option');
          opt.value = h;
          opt.textContent = h;
          horarioSel.appendChild(opt);
        });
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      mensagem.textContent = '';
      const nome = document.getElementById('nome').value.trim();
      const cpf = document.getElementById('cpf').value.trim();
      const local = localSel.value;
      const data = dataSel.value;
      const horario = horarioSel.value;

      const resposta = await fetch(URL_CSV);
      const texto = await resposta.text();
      const linhas = texto.trim().split('\n').slice(1);
      const encontrado = linhas.find(l => {
        const [nome_linha, cpf_linha, local_linha, data_linha] = l.split(',');
        return cpf_linha === cpf;
      });

      if (encontrado) {
        const agendadoData = encontrado.split(',')[3];
        mensagem.textContent = `Você já tem um agendamento para o dia ${agendadoData}. Cancele o anterior para agendar outro.`;
        mensagem.className = 'mensagem erro';
        return;
      }

      fetch('https://script.google.com/macros/s/AKfycbz8mxO5Qf8fpPm_N3BzVWKn9NkM_0V8IhT5nsYAbWGwv2Iv9I9kup4EE1GswyrLrseWFQ/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `nome=${encodeURIComponent(nome)}&cpf=${encodeURIComponent(cpf)}&local=${encodeURIComponent(local)}&data=${encodeURIComponent(data)}&horario=${encodeURIComponent(horario)}&acao=agendar`
      });

      mensagem.textContent = 'Agendamento realizado com sucesso!';
      mensagem.className = 'mensagem sucesso';
      form.reset();
      dataSel.innerHTML = '<option value="">Selecione a Data</option>';
      horarioSel.innerHTML = '<option value="">Selecione o Horário</option>';
    });

    cancelarBtn.addEventListener('click', () => {
      const nome = document.getElementById('nome').value.trim();
      const cpf = document.getElementById('cpf').value.trim();
      const local = localSel.value;
      const data = dataSel.value;
      const horario = horarioSel.value;

      fetch('https://script.google.com/macros/s/AKfycbz8mxO5Qf8fpPm_N3BzVWKn9NkM_0V8IhT5nsYAbWGwv2Iv9I9kup4EE1GswyrLrseWFQ/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `nome=${encodeURIComponent(nome)}&cpf=${encodeURIComponent(cpf)}&local=${encodeURIComponent(local)}&data=${encodeURIComponent(data)}&horario=${encodeURIComponent(horario)}&acao=cancelar`
      });

      mensagem.textContent = `Agendamento cancelado para ${nome} em ${data}`;
      mensagem.className = 'mensagem sucesso';
      form.reset();
      dataSel.innerHTML = '<option value="">Selecione a Data</option>';
      horarioSel.innerHTML = '<option value="">Selecione o Horário</option>';
    });
  </script>
</body>
</html>
