<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamento Piscicultores - Açude Castanhão</title>
  <style>
    body { font-family: sans-serif; background-color: #f5f5f5; padding: 2rem; }
    .container { background: white; padding: 2rem; max-width: 600px; margin: auto; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; margin-bottom: 1rem; }
    label { display: block; margin-top: 1rem; }
    input, select, button { width: 100%; padding: 0.8rem; margin-top: 0.3rem; border: 1px solid #ccc; border-radius: 8px; }
    button { background-color: #007bff; color: white; font-weight: bold; margin-top: 1rem; cursor: pointer; }
    .mensagem { margin-top: 1rem; font-weight: bold; }
    .erro { color: red; }
    .sucesso { color: green; }
    .logo { text-align: center; margin-bottom: 1rem; }
    .logo img { max-width: 400px; height: auto; }
  </style>
</head>
<body>
  <div class="logo">
    <img src="MAPAAssinatura.png" alt="Ministério da Pesca e Aquicultura - Governo Federal">
  </div>
  <div class="container">
    <h2>Agendamento Piscicultores - Açude Castanhão</h2>
    <form id="form">
      <label for="local">Local:</label>
      <select id="local" required>
        <option value="">Selecione o Local</option>
        <option value="Jaguaribara-CE">Jaguaribara-CE</option>
        <option value="Curupati Peixe-CE">Curupati Peixe-CE</option>
      </select>

      <label for="data">Data:</label>
      <select id="data" required>
        <option value="">Selecione a Data</option>
      </select>

      <label for="horario">Horário:</label>
      <select id="horario" required>
        <option value="">Selecione o Horário</option>
      </select>

      <label for="nome">Nome:</label>
      <input type="text" id="nome" required />

      <label for="telefone">Telefone (com DDD):</label>
      <input type="text" id="telefone" required maxlength="15" placeholder="(99) 99999-9999"
        oninput="this.value=this.value.replace(/\D/g,'').replace(/(\d{2})(\d)/,'($1) $2').replace(/(\d{5})(\d)/,'$1-$2').slice(0,15);">

      <label for="cpf">CPF:</label>
      <input type="text" id="cpf" required maxlength="14" placeholder="000.000.000-00"
        oninput="this.value=this.value.replace(/[^\d]/g,'').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2');">

      <button type="submit">Agendar</button>
      <button type="button" id="cancelarBtn">Cancelar Agendamento</button>
      <div class="mensagem" id="mensagem"></div>
    </form>
  </div>

  <script>
    // ================ CONFIGURAÇÕES ================
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQD1qSlIS71--xdEJ3LJCzuXdrF876fOzrsotEL45rPraJ_Cg8UkJvQ8wtZXn2eWAzMGQevP2qtviJH/pub?gid=0&single=true&output=csv';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwvYUDpWuWa9SirLpY8OCzgBShxYwMtupIFiRnqmXewgt18dbtVzmGyRsqvaFQSB2WkUA/exec';
    const LIMITE = 5; // vagas por horário

    // ================ DATAS & HORÁRIOS ================
    const datasMap = {
      'Jaguaribara-CE': ['12/05', '13/05', '15/05', '16/05'],
      'Curupati Peixe-CE': ['14/05']
    };
    const horariosMap = {
      'Jaguaribara-CE': ['17:00','17:15','17:30','17:45','18:00','18:15','18:30','18:45','19:00','19:15','19:30','19:45','20:00','20:15','20:30','20:45'],
      'Curupati Peixe-CE': ['13:00','13:15','13:30','13:45','14:00','14:15','14:30','14:45','15:00','15:15','15:30','15:45','16:00','16:15','16:30','16:45']
    };

    // ================ ELEMENTOS ================
    const localSel   = document.getElementById('local');
    const dataSel    = document.getElementById('data');
    const horarioSel = document.getElementById('horario');
    const msgEl      = document.getElementById('mensagem');
    const form       = document.getElementById('form');
    const cancelBtn  = document.getElementById('cancelarBtn');

    // ================ FUNÇÕES ================
    const fetchCSV = () => fetch(CSV_URL).then(r => r.text());

    const ocupados = (rows, local, data, horario) => rows.filter(r => {
      const [,,loc,dt,hr] = r.split(',');
      return loc===local && dt===data && hr===horario;
    }).length;

    const mostraMsg = (txt, ok=false) => {
      msgEl.textContent = txt;
      msgEl.className = `mensagem ${ok?'sucesso':'erro'}`;
    };

    // ================ POPULAR SELECT LOCAL -> DATAS ================
    localSel.addEventListener('change', async () => {
      dataSel.innerHTML = '<option value="">Selecione a Data</option>';
      horarioSel.innerHTML = '<option value="">Selecione o Horário</option>';
      const local = localSel.value;
      if (!local) return;
      let rows = [];
      try {
        rows = (await fetchCSV()).trim().split('\n').slice(1);
      } catch (e) {
        console.error(e);
        return mostraMsg('Erro ao acessar planilha.');
      }
      datasMap[local].forEach(d => {
        const livres = horariosMap[local].reduce((acc,h) => acc + (ocupados(rows,local,d,h)<LIMITE?1:0),0);
        const opt = new Option(`${d} - ${livres} horário(s)`, d);
        if(livres===0) opt.style.color='#bbb';
        dataSel.add(opt);
      });
    });

    // ================ POPULAR HORÁRIOS ================
    dataSel.addEventListener('change', async () => {
      horarioSel.innerHTML = '<option value="">Selecione o Horário</option>';
      const local = localSel.value;
      const data  = dataSel.value;
      if (!data) return;
      let rows = [];
      try {
        rows = (await fetchCSV()).trim().split('\n').slice(1);
      } catch(e){
        console.error(e);
        return mostraMsg('Erro ao acessar planilha.');
      }
      horariosMap[local].forEach(h => {
        const livres = LIMITE - ocupados(rows,local,data,h);
        const opt = new Option(`${h} - ${livres} vaga(s)`, h);
        if(livres===0) opt.style.color='#bbb';
        horarioSel.add(opt);
      });
    });

    // ================ SUBMISSÃO ================
    form.addEventListener('submit', async e => {
      e.preventDefault();
      mostraMsg('');
      const nome = document.getElementById('nome').value.trim();
      const cpf  = document.getElementById('cpf').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const local = localSel.value;
      const data  = dataSel.value;
      const horario = horarioSel.value;

      const rows = (await fetchCSV()).trim().split('\n').slice(1);
      if(rows.find(r=>r.split(',')[1]===cpf))
        return mostraMsg('CPF já possui agendamento.');

      await fetch(APPS_SCRIPT_URL, {
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:new URLSearchParams({nome,cpf,telefone,local,data,horario,acao:'agendar'})
      });
      mostraMsg('Agendamento realizado com sucesso!', true);
      form.reset();
      dataSel.innerHTML='<option value="">Selecione a Data</option>';
      horarioSel.innerHTML='<option value="">Selecione o Horário</option>';
    });

    cancelBtn.addEventListener('click', async () => {
      const cpf = document.getElementById('cpf').value.trim();
      const local = localSel.value;
      const data  = dataSel.value;
      const horario = horarioSel.value;
      if(!cpf||!local||!data||!horario) return mostraMsg('Preencha CPF, local, data e horário.');
      await fetch(APPS_SCRIPT_URL, {
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:new URLSearchParams({cpf,local,data,horario,acao:'cancelar'})
      });
      mostraMsg('Agendamento cancelado!', true);
      form.reset();
      dataSel.innerHTML='<option value="">Selecione a Data</option>';
      horarioSel.innerHTML='<option value="">Selecione o Horário</option>';
    });
  </script>
</body>
</html>
